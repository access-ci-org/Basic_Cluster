---
- name: Clone the git repo to the machine
  git: 
    repo: "{{ rabbitmq_agents_repo }}"
    dest: "{{ rabbitmq_agents_loc }}"
    version: "{{ rabbitmq_agents_version }}"

- name: Make a copy of rabbit config example file
  template:
    src: config.j2
    dest: "{{ rabbitmq_agents_loc }}/rabbit_config.py"

- name: Check if environment is properly setup, and install python packages if not
  pip:
    requirements: requirements.txt
    virtualenv: venv
    virtualenv_command: /usr/bin/python3 -m venv
    chdir: "{{ rabbitmq_agents_loc }}"

- name: Copy service files to the machine.
  template:
    src: "{{ item }}.j2"
    dest: "/etc/systemd/system/{{ item }}.service"
  loop:
    - ohpc_account_agent
    - slurm_account_agent

- name: Add Vhost in RabbitMQ
  rabbitmq_vhost:
    name: "{{ rabbitmq_vhost }}"
    state: present

- name: Add User in RabbitMQ
  rabbitmq_user:
    user: "{{ rabbitmq_user }}"
    password: "{{ rabbitmq_user_password }}"
    vhost: "{{ rabbitmq_vhost }}"
    configure_priv: .*
    read_priv: .*
    write_priv: .*
    state: present

- name: Start ohpc_account.service
  service:
    name: ohpc_account_agent.service
    state: started
    enabled: yes

- name: Start slurm_account.service
  service:
    name: slurm_account_agent.service
    state: started
    enabled: yes
